<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ประกาศผลรางวัล Lucky Draw</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      font-size: 28px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      background-color: #f4f4f4;
    }

    .container {
      width: 90%;
      max-width: 960px;
      text-align: center;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    h2, h3 { color: #333; }

    label { display: block; margin-bottom: 15px; }

    input[type="text"], input[type="file"] {
      padding: 15px;
      font-size: 24px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 25px;
      width: calc(100% - 32px);
      max-width: 350px;
      text-align: center;
    }
    input[type="file"]{ text-align:left;padding:10px; }

    button {
      padding: 15px 30px;
      font-size: 24px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 8px;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #0056b3; }
    button:disabled{ background:#ccc;cursor:not-allowed; }

    #resultsTableContainer{ margin-top:40px;text-align:left;padding:0 20px; }
    table{ width:100%;border-collapse:collapse;margin-top:20px; }
    th,td{ border:1px solid #ddd;padding:15px;text-align:left; }
    th{ background:#f2f2f2;font-weight:bold; }

    @media screen and (max-width:600px){
      table,thead,tbody,th,td,tr{display:block}
      thead tr{position:absolute;top:-9999px;left:-9999px}
      tr{margin:0 0 1.5rem;border:1px solid #ddd;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
      td{border:none;border-bottom:1px solid #eee;position:relative;padding-left:55%;text-align:right}
      td:before{position:absolute;top:0;left:6px;width:50%;padding-right:10px;white-space:nowrap;text-align:left;font-weight:bold}
      td:nth-of-type(1):before{content:"E-TICKET ID"}
      td:nth-of-type(2):before{content:"ชื่อ-นามสกุล"}
      td:nth-of-type(3):before{content:"ร้านยา"}
      td:nth-of-type(4):before{content:"รางวัลที่ได้"}
      td:nth-of-type(5):before{content:"สถานะรับรางวัล"}
      td:nth-of-type(6):before{content:"รูปภาพยืนยัน"}
    }

    .modal{display:none;position:fixed;z-index:99999;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.6);justify-content:center;align-items:center;opacity:1!important;visibility:visible!important}
    .modal-content{background:#FFDDDD;border:2px solid red;margin:auto;padding:30px;box-sizing:border-box;width:80%;max-width:500px;height:auto;min-width:300px;min-height:150px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.3);text-align:center;position:relative;overflow:auto}
    .modal-content h3{margin-top:0;color:#333}
    .modal-content p{font-size:20px;margin-bottom:20px}
    .modal-buttons{display:flex;justify-content:center;gap:15px;width:100%;box-sizing:border-box}
    .modal-buttons button{padding:10px 20px;font-size:18px;border-radius:5px;cursor:pointer}
    .modal-buttons .confirm-btn{background:#28a745}
    .modal-buttons .confirm-btn:hover{background:#218838}
    .modal-buttons .cancel-btn{background:#dc3545}
    .modal-buttons .cancel-btn:hover{background:#c82333}
    .modal-close-btn{color:#aaa;position:absolute;top:10px;right:15px;font-size:28px;font-weight:bold;cursor:pointer}
    .modal-close-btn:hover{color:#000}

    #imageUploadSection{margin-top:20px;padding:20px;border:1px dashed #ccc;border-radius:8px;background:#f9f9f9;display:none}
    #imagePreview{max-width:100%;max-height:200px;margin-top:15px;border-radius:4px;display:none}
    #loadingIndicator{display:none;margin-top:15px;font-size:18px;color:#007bff}
    .uploaded-image-display{max-width:150px;max-height:150px;border-radius:4px;margin-top:10px;border:1px solid #ddd}
  </style>
</head>
<body>
  <div class="container">
    <h2>ตรวจสอบผลรางวัล Lucky Draw</h2>
    <h2>Annual General Meeting 2025</h2>

    <label for="eticketIdInput">กรอก E-Ticket ID ของคุณ:</label>
    <input type="text" id="eticketIdInput" placeholder="เช่น 001, 123">
    <button onclick="checkPrize()">ตรวจสอบรางวัล</button>

    <div id="resultsTableContainer"></div>

    <div id="imageUploadSection">
      <h3>อัปโหลดรูปภาพยืนยันการรับรางวัล</h3>
      <input type="file" id="imageInput" accept="image/*">
      <img id="imagePreview" src="#" alt="Image Preview">
      <p id="loadingIndicator">กำลังอัปโหลดรูปภาพ...</p>
    </div>

    <button id="confirmReceiptBtn" style="display:none;" disabled>ยืนยันการรับรางวัล</button>

    <div id="customModal" class="modal">
      <div class="modal-content">
        <span class="modal-close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <div id="modalButtons" class="modal-buttons"></div>
      </div>
    </div>

    <script>
      const getPrizeAppsScriptUrl = 'https://script.google.com/macros/s/AKfycbxdBIo1XcrnQjtRxuidUTvjXc7GN_AreoocUqhpc6GMimZ1KPz0d8uM-m7Eg_cfjxfU/exec';
      const confirmReceiptAppsScriptUrl = 'https://script.google.com/macros/s/AKfycby7TUi5lGGsaIJ-v1s8YfHfd7XWPL4v_m18VY0ivFRzPKVSqfMbrR9xR_mIeKNt8wCE/exec';

      let currentEticketId = null;
      let resolveModalPromise;

      function showModal(title, message, type = 'alert') {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        const modalButtons = document.getElementById('modalButtons');
        modalButtons.innerHTML = '';

        if (type === 'alert') {
          modalButtons.innerHTML = `<button class="confirm-btn" onclick="closeModal(true)">ตกลง</button>`;
        } else if (type === 'confirm') {
          modalButtons.innerHTML = `
            <button class="confirm-btn" onclick="closeModal(true)">ยืนยัน</button>
            <button class="cancel-btn" onclick="closeModal(false)">ยกเลิก</button>`;
          return new Promise(res => resolveModalPromise = res);
        }
        modal.style.display = 'flex';
      }
      function closeModal(result=false){
        document.getElementById('customModal').style.display='none';
        if(resolveModalPromise){resolveModalPromise(result);resolveModalPromise=null;}
      }

      document.getElementById('imageInput').addEventListener('change', e=>{
        const file = e.target.files[0];
        const imgPrev = document.getElementById('imagePreview');
        const confirmBtn = document.getElementById('confirmReceiptBtn');
        if(file){
          const reader = new FileReader();
          reader.onload = ev =>{
            imgPrev.src = ev.target.result;
            imgPrev.style.display='block';
            confirmBtn.disabled=false;
          };
          reader.readAsDataURL(file);
        }else{
          imgPrev.style.display='none';
          imgPrev.src='#';
          confirmBtn.disabled=true;
        }
      });

      async function checkPrize(){
        const eticketId = document.getElementById('eticketIdInput').value.trim();
        const resultsContainer = document.getElementById('resultsTableContainer');
        const uploadSec = document.getElementById('imageUploadSection');
        const confirmBtn = document.getElementById('confirmReceiptBtn');
        const imgPreview = document.getElementById('imagePreview');
        const imgInput = document.getElementById('imageInput');

        uploadSec.style.display='none';
        confirmBtn.style.display='none';
        confirmBtn.disabled=true;
        imgPreview.style.display='none';
        imgPreview.src='#';
        imgInput.value='';
        currentEticketId=null;

        if(!/^\d+$/.test(eticketId)){
          showModal('ข้อผิดพลาด','กรุณากรอก E-Ticket ID ที่ถูกต้อง (ตัวเลขเท่านั้น)');
          return;
        }
        resultsContainer.innerHTML = `<p>กำลังตรวจสอบรางวัลสำหรับ E-Ticket ID: ${eticketId}...</p>`;

        try{
          const resp = await fetch(`${getPrizeAppsScriptUrl}?id=${eticketId}`);
          if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          if(data.status==='success' && data.prizeDetails){
            const p = data.prizeDetails; currentEticketId = p.id;
            let receiptStatus='', imageHtml='';
            if(p.registrationStatus!=='Registered') receiptStatus='ไม่ได้ลงทะเบียน';
            else if(!p.prize) receiptStatus='ยังไม่ได้รับรางวัล';
            else if(p.receiptStatus==='รับรางวัลแล้ว'){ receiptStatus='รับรางวัลแล้ว'; if(p.imageUrl) imageHtml=`<img src="${p.imageUrl}" class="uploaded-image-display">`; }
            else{ receiptStatus='ยังไม่ได้รับรางวัล'; uploadSec.style.display='block'; confirmBtn.style.display='inline-block'; }

            resultsContainer.innerHTML=`<h3>ผลการตรวจสอบรางวัลสำหรับ E-Ticket ID: ${p.id}</h3>
              <table>
                <thead><tr><th>E-TICKET ID</th><th>ชื่อ-นามสกุล</th><th>ร้านยา</th><th>รางวัลที่ได้</th><th>สถานะรับรางวัล</th><th>รูปภาพยืนยัน</th></tr></thead>
                <tbody><tr>
                  <td>${p.id||'-'}</td><td>${p.name||'-'}</td><td>${p.shop||'-'}</td><td>${p.prize||'ไม่ได้รับรางวัล'}</td><td>${receiptStatus}</td><td>${imageHtml}</td>
                </tr></tbody></table>`;
          }else{
            resultsContainer.innerHTML=`<p style="color:orange">ไม่พบข้อมูลรางวัลสำหรับ E-Ticket ID: ${eticketId}</p>`;
          }
        }catch(err){
          console.error(err);
          resultsContainer.innerHTML=`<p style="color:red">เกิดข้อผิดพลาดในการดึงข้อมูลรางวัล: ${err.message}</p>`;
        }
      }

      async function confirmPrizeReceipt(){
        const eticketId = currentEticketId;
        const resultsContainer = document.getElementById('resultsTableContainer');
        const imgInput = document.getElementById('imageInput');
        const loading = document.getElementById('loadingIndicator');
        const confirmBtn = document.getElementById('confirmReceiptBtn');

        if(!eticketId){ showModal('ข้อผิดพลาด','ไม่พบ E-Ticket ID ที่จะยืนยัน'); return; }
        if(!imgInput.files.length){ showModal('ข้อผิดพลาด','กรุณาเลือกรูปภาพยืนยันการรับรางวัลก่อน'); return; }

        resultsContainer.innerHTML=`<p>กำลังบันทึกข้อมูลการรับรางวัลสำหรับ E-Ticket ID: ${eticketId}...</p>`;
        loading.style.display='block'; confirmBtn.disabled=true;

        try{
          const file = imgInput.files[0];
          const reader = new FileReader();
          reader.onloadend = async () =>{
            const base64Data = reader.result.split(',')[1];
            try{
              const resp = await fetch(confirmReceiptAppsScriptUrl,{
                method:'POST',
                headers:{'Content-Type':'text/plain'}, // *** เปลี่ยนตรงนี้เพื่อหลบ preflight
                body:JSON.stringify({
                  eticketId,
                  imageData:base64Data,
                  mimeType:file.type,
                  fileName:file.name
                })
              });
              loading.style.display='none';
              if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
              const result = await resp.json();
              if(result.status==='success') showModal('สำเร็จ','บันทึกข้อมูลการรับรางวัลและอัปโหลดรูปภาพแล้ว!');
              else showModal('ข้อผิดพลาด',`เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${result.message}`);
              await checkPrize();
            }catch(fetchErr){
              loading.style.display='none'; confirmBtn.disabled=false;
              console.error(fetchErr);
              showModal('ข้อผิดพลาด','เกิดข้อผิดพลาดในการเชื่อมต่อหรือส่งข้อมูล: '+fetchErr.message);
            }
          };
          reader.readAsDataURL(file);
        }catch(err){
          loading.style.display='none'; confirmBtn.disabled=false;
          console.error(err);
          showModal('ข้อผิดพลาด','เกิดข้อผิดพลาดในการบันทึกข้อมูลการรับรางวัล: '+err.message);
        }
      }

      document.getElementById('confirmReceiptBtn').addEventListener('click',confirmPrizeReceipt);
    </script>
  </div>
</body>
</html>
